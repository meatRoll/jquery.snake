!function(t,n){function i(i,o,e,a){this.canvas=i,this.row=o,this.column=e,this.canChangeDirection=!0,this.direction="1 0",this.ate=0;for(var r in a)"initialPostion"===r?this.body=a[r]:this[r]=a[r];this.data=this.body.slice(),this.setTime();var s=this;t(n).on("click",function(t){t.target===s.canvas.get(0)?s.isOnfocus=!0:s.isOnfocus=!1}),t(n).on("keydown",function(t){if(s.isOnfocus&&s.canChangeDirection){var n=s.direction;switch(t.keyCode){case s.controls.up:"0 1"!==s.direction&&(s.direction="0 -1");break;case s.controls.down:"0 -1"!==s.direction&&(s.direction="0 1");break;case s.controls.left:"1 0"!==s.direction&&(s.direction="-1 0");break;case s.controls.right:"-1 0"!==s.direction&&(s.direction="1 0")}return n!==s.direction&&(s.canChangeDirection=!1),!1}})}function o(t,n,i,o){this.snake=t,this.food=n,this.map=i;for(var e in o)this[e]=o[e];this.getMap(),this.getRandomArrayElement()}function e(t,n,i,o,e){this.canvas=t,this.unit=n,this.snake=i,this.food=o,this.deadSnake=0,this.ganmeover=e,this.ctx=this.canvas.get(0).getContext("2d")}t.extend(i.prototype,{walk:function(){if(!this.announcer)throw new Error("没有绑定对应Drawer对象");this.stop();var t=this;this.clockId=setInterval(function(){t.setChange(t.direction),t.canChangeDirection=!0,t.checkIsAte(),t.checkIsAlive()},this.time)},setChange:function(t){var n=t.split(" "),i=this.body[0].split(" ").map(function(t,i){return Number(t)+Number(n[i])},this).join(" ");this.data=[],this.data.push(i),this._body=this.body.slice(),this.body.unshift(i),this.waste=[],this.waste.push(this.body.pop())},checkIsAte:function(){this.announcer.food.some(function(t){if(this.body[0]===t.data[0])return t.changePosition(),!0},this)&&(this.ate++,this.waste=[],this.body.push(this._body[this._body.length-1]))},checkIsAlive:function(){var t=this;setTimeout(function(){var n,i=t.body[0];i.split(" ").forEach(function(n,i){var o,e=Number(n);o=0===i?t.row:t.column,(e<1||e>o)&&t.die()}),t.announcer.snake.forEach(function(o){(n=o===t?o.body.slice(1):o.body).some(function(n,e){if(i===n)return 0===e&&t.direction.split(" ").some(function(t){return o.direction.split(" ").some(function(n){return"0"!==t&&Number(t)===-Number(n)})})&&(o._body=o.body,o.die()),!0})&&t.die()}),t.announcer.announce(t)},5)},die:function(){this.stop(),this.body=[],this.data=[],this.waste=this._body,this.died&&this.died(this.announcer),this.announcer.announce(this)},stop:function(){clearInterval(this.clockId)},setTime:function(){this.time=50*(10-this.speed)}}),t.extend(o.prototype,{getRandomArrayElement:function(){var t=this.foodMap.length;this.data=[],this.data.push(this.foodMap[Math.floor(0+Math.random()*t)])},filtrateArray:function(t,n){var i=t;return i=i.filter(function(t){return!n.some(function(n){return t===n})})},getMap:function(){var t=[];this.snake.forEach(function(n){t=t.concat(n.body)}),this.food.forEach(function(n){n.position&&t.push(n.position)}),this.foodMap=this.filtrateArray(this.map,t)},changePosition:function(){if(!this.announcer)throw new Error("没有绑定对应Drawer对象");this.getMap(),0!==this.foodMap.length?(this.getRandomArrayElement(),this.announcer.announce(this)):this.data=[]}}),t.extend(e.prototype,{initialize:function(){this.clear(),this.snake.forEach(function(t){this.get_data(t),this.draw(t),this.bind(t)},this),this.food.forEach(function(t){this.get_data(t),this.draw(t),this.bind(t)},this)},bind:function(t){t.announcer=this},announce:function(t){this.get_data(t),this.draw(t)},calcultateDeath:function(){this.deadSnake++,(this.deadSnake===this.snake.length||this.ganmeover)&&this.ganmeover(this.drawer)},get_data:function(t){t._data=t.data.map(function(t){return this.calculateSquare(t)},this),t.waste&&(t._waste=t.waste.map(function(t){return this.calculateSquare(t)},this))},calculateSquare:function(t){var n=t.split(" ");return[(n[0]-1)*this.unit,(n[1]-1)*this.unit]},draw:function(t){var n=this.ctx;n.beginPath(),n.save(),t._waste&&t._waste.forEach(function(t){n.clearRect(t[0],t[1],this.unit,this.unit)},this),n.fillStyle=t.color,t._data.forEach(function(t){n.fillRect(t[0],t[1],this.unit,this.unit)},this),n.restore()},clear:function(){this.ctx.clearRect(0,0,this.canvas.width(),this.canvas.height())}}),t.fn.snake=function(n){function a(){(_=new e(s,c,y,E,n.common&&n.common.ganmeovered)).clear(),_.initialize(),n.common&&n.common.beforeStarted?n.common.beforeStarted(_,r):r()}function r(){y.forEach(function(t){t.walk()})}var s=t(this);if(!s.get(0).getContext)throw new Error("不支持canvas");var c=(n="object"==typeof n?n:{}).common&&n.common.unit||10,h=n.common&&n.common.speed||5,d=n.background&&n.background.color||"white",u=n.border&&n.border.color||"black",f=n.border&&n.border.width||10,l=n.border&&n.border.style||"solid";if(s.width()%c!=0)throw new Error("canvas宽度与unit不符");if(s.height()%c!=0)throw new Error("canvas高度与unit不符");n.snake&&0!==n.snake.length||(n.snake=[{}]);var m=[];n.snake.forEach(function(t,n){m[n]={};for(var i in t)if("initialDirection"===i)switch(t[i]){case"up":m[n].direction="0 -1";break;case"down":m[n].direction="0 1";break;case"left":m[n].direction="-1 0";break;case"right":m[n].direction="1 0"}else m[n][i]=t[i];0===n&&(m[n].color=m[n].color||"black",m[n].controls||(m[n].controls={},m[n].controls.up=38,m[n].controls.down=40,m[n].controls.left=37,m[n].controls.right=39)),m[n].speed=m[n].speed||h}),n.food&&0!==n.food.length||(n.food=[{}]);var b=[];n.food.forEach(function(t,n){b[n]={};for(var i in t)b[n][i]=t[i];b[n].color=b[n].color||"red"}),s.css({border:f+"px "+l+" "+u,background:d});for(var w=s.width()/c,g=s.height()/c,p=[],v=1;v<=w;v++)for(var k=1;k<=g;k++)p.push(v+" "+k);var y=[];m.forEach(function(t,n){y[n]=new i(s,w,g,t)});var E=[];b.forEach(function(t,n){E[n]=new o(y,E,p,t)});var _,x=s.get(0).getContext("2d");return n.common&&n.common.beforeDrawn?n.common.beforeDrawn(x,a):a(),this}}(jQuery,window);